name: Deploy NihongoBot

on:
    push:
        branches:
            - main  # Trigger on push to main
    workflow_dispatch:

jobs:
    deploy:
        runs-on: self-hosted

        steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Setup .NET
          uses: actions/setup-dotnet@v4
          with:
            dotnet-version: 9.0.x
        - name: Replace Variables in appsettings.json
          uses: microsoft/variable-substitution@v1
          with:
              files: '*/appsettings.json'
          env:
              TelegramBotToken: ${{ secrets.TELEGRAM_BOT_TOKEN }}

        - name: Build the Project
          run: dotnet build

        - name: Publish the Project
          run: dotnet publish -c Release -t:PublishContainer --nologo -r "linux-x64" -p:ContainerRepository="nihongobot" -p:ContainerImageTag="latest"

        - name: Copy Docker Compose File
          run: cp docker-compose.yml /home/dennis/nihongoBot

        - name: Restart NihongoBot Container
          run: |
                cd /home/dennis/nihongoBot
                docker compose down
                docker compose up -d
